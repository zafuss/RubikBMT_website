<!doctype html>
<html lang="en" class="light-style layout-menu-fixed layout-compact" dir="ltr"
      data-theme="theme-default" data-assets-path="/admin/assets/"
      data-template="vertical-menu-template-free" data-style="light">
<head th:replace="~{library/lib_admin.html::head('User Management')}">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
<!-- Layout wrapper -->
<div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
        <!-- Menu -->
        <aside th:replace="~{library/lib_admin.html::sidebar}"></aside>
        <!-- / Menu -->

        <!-- Layout container -->
        <div class="layout-page">
            <!-- Navbar -->
            <nav th:replace="~{library/lib_admin.html::navbar}"></nav>
            <!-- / Navbar -->

            <!-- Content wrapper -->
            <div class="content-wrapper">
                <!-- Content -->
                <div class="container-xxl flex-grow-1 container-p-y">
                    <!-- Basic Bootstrap Table -->
                    <div class="card">
                        <h5 class="card-header">Thêm lớp học</h5>
                        <div class="card-body">
                            <!-- Form thêm user -->
                            <form th:action="@{/classrooms/addClassroom}" th:object="${classroom}" method="post">
                                <div class="mb-3">
                                    <label class="form-label">Tên lớp học</label>
                                    <input type="text" class="form-control" th:field="*{name}" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Khoá học</label>
                                    <select class="form-select" th:field="*{course}" id="courseSelect">
                                        <option value="">Chọn khoá học</option>
                                        <option th:each="course : ${courses}" th:value="${course.id}" th:text="${course.name}"
                                                th:data-total-fee="${course.totalFee}" th:data-num-sessions="${course.numOfSessions}" th:data-mins-per-session="${course.minutesPerSession}">
                                        </option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Giáo viên</label>
                                    <select class="form-select" th:field="*{teacher}">
                                        <option value="">Chọn giáo viên</option>
                                        <option th:each="teacher : ${teachers}" th:value="${teacher.id}" th:text="${teacher.lastName} + ' ' + ${teacher.firstName}"></option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Học phí</label>
                                    <input type="number" class="form-control" th:field="*{actualFee}" id="actualFee" required>
                                </div>
                               <div class="mb-3">
                                    <label class="form-label">Chọn ngày giờ buổi học đầu tiên</label>
                                    <input type="datetime-local" class="form-control" th:field="*{startDate}" id="startDate" required>
                                </div>

                                <div class="mb-3" id="sessionInfo" style="display: none;">
                                    <label class="form-label">Tổng số buổi học:</label>
                                    <span id="numOfSessions"></span>
                                    <label class="form-label">Số phút mỗi buổi:</label>
                                    <span id="minutesPerSession"></span>
                                </div>
                                <div id="sessionInputs" class="mb-3"></div>

                                <button type="submit" class="btn btn-success">Lưu</button>
                                <a href="/classrooms" class="btn btn-secondary">Hủy</a>

                            </form>
                        </div>
                    </div>
                </div>
                <!-- / Content -->
            </div>
            <!-- Content wrapper -->
        </div>
        <!-- / Layout page -->
    </div>

    <!-- Overlay -->
    <div class="layout-overlay layout-menu-toggle"></div>
</div>
<!-- / Layout wrapper -->

<!-- Core JS -->
<script src="/admin/assets/vendor/libs/jquery/jquery.js"></script>
<script src="/admin/assets/vendor/libs/popper/popper.js"></script>
<script src="/admin/assets/vendor/js/bootstrap.js"></script>
<script src="/admin/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
<script src="/admin/assets/vendor/js/menu.js"></script>

<!-- Vendors JS -->
<script src="/admin/assets/vendor/libs/apex-charts/apexcharts.js"></script>
<!-- Main JS -->
<script src="/admin/assets/js/main.js"></script>
<!-- Page JS -->
<script src="/admin/assets/js/dashboards-analytics.js"></script>

<script>
    const courseSelect = document.getElementById('courseSelect');
    const startDateInput = document.getElementById('startDate');
    const sessionInfoDiv = document.getElementById('sessionInfo');

    courseSelect.addEventListener('change', function () {
        const selectedOption = this.options[this.selectedIndex];
        const totalFee = selectedOption.getAttribute('data-total-fee');
        const numOfSessions = parseInt(selectedOption.getAttribute('data-num-sessions'), 10) || 0;
        const minutesPerSession = parseInt(selectedOption.getAttribute('data-mins-per-session'), 10) || 0;

        document.getElementById('actualFee').value = totalFee || '';

        if (numOfSessions > 0) {
            document.getElementById('numOfSessions').textContent = numOfSessions;
            document.getElementById('minutesPerSession').textContent = minutesPerSession;
            sessionInfoDiv.style.display = 'block';
        } else {
            sessionInfoDiv.style.display = 'none';
        }

        // Tạo input datetime-local sau khi chọn khoá học
        generateSessionInputs(numOfSessions, minutesPerSession);
    });

    startDateInput.addEventListener('change', function () {
        const selectedOption = courseSelect.options[courseSelect.selectedIndex];
        const numOfSessions = parseInt(selectedOption.getAttribute('data-num-sessions'), 10) || 0;
        const minutesPerSession = parseInt(selectedOption.getAttribute('data-mins-per-session'), 10) || 0;

        generateSessionInputs(numOfSessions, minutesPerSession);
    });

    function generateSessionInputs(numOfSessions) {
        const container = document.getElementById('sessionInputs');
        container.innerHTML = '';

        const startDate = new Date(startDateInput.value);
        if (isNaN(startDate)) return;

        for (let i = 1; i <= numOfSessions; i++) {
            const sessionLabel = document.createElement('label');
            sessionLabel.className = 'form-label';
            sessionLabel.textContent = `Buổi học ${i}`;

            const sessionInput = document.createElement('input');
            sessionInput.type = 'datetime-local';
            sessionInput.className = 'form-control';
            sessionInput.name = `sessionDates`;

            // Tính thời gian buổi học tiếp theo (1 tuần sau mỗi buổi học)
            const nextSessionTime = new Date(startDate.getTime() + (i - 1) * 7 * 24 * 60 * 60 * 1000);

            // Định dạng datetime-local (YYYY-MM-DDTHH:MM)
            sessionInput.value = formatLocalDateTime(nextSessionTime);

            container.appendChild(sessionLabel);
            container.appendChild(sessionInput);
        }
    }

    // Hàm định dạng Date thành datetime-local
    function formatLocalDateTime(date) {
        const pad = (num) => num.toString().padStart(2, '0');
        return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
    }
</script>

</body>
</html>
